fix(api): use transaction for quota check to prevent race conditions